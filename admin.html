<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - GIFT College</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="college-header">
            <div class="college-branding">
                <img src="https://top-autonomous-college-in-odisha.gift.edu.in/wp-content/uploads/2024/12/logo.png" alt="GIFT Logo" class="college-logo">
                <div class="college-info">
                    <h1 class="college-name">Gandhi Institute for Technology</h1>
                    <p class="college-details">Bhubaneswar, Odisha</p>
                </div>
            </div>
            <div class="user-controls">
                <button id="themeToggle" class="theme-btn">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </header>

        <main class="dashboard-container">
            <div class="admin-sidebar">
                <nav>
                    <ul>
                        <li class="active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            Dashboard
                        </li>
                        <li data-section="students">
                            <i class="fas fa-user-graduate"></i>
                            Students
                        </li>
                        <li data-section="marks">
                            <i class="fas fa-chart-bar"></i>
                            Marks
                        </li>
                        <li data-section="reports">
                            <i class="fas fa-file-alt"></i>
                            Reports
                        </li>
                    </ul>
                </nav>
            </div>

            <div class="admin-content">
                <!-- Dashboard Section -->
                <section id="dashboard" class="admin-section active">
                    <h2>Dashboard Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-user-graduate"></i>
                            <div class="stat-info">
                                <h3>Total Students</h3>
                                <p id="totalStudents">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-chart-line"></i>
                            <div class="stat-info">
                                <h3>Average Score</h3>
                                <p id="avgScore">0%</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-star"></i>
                            <div class="stat-info">
                                <h3>Top Performers</h3>
                                <p id="topPerformers">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="stat-info">
                                <h3>Need Attention</h3>
                                <p id="needAttention">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="performance-charts">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </section>

                <!-- Students Section -->
                <section id="students" class="admin-section">
                    <h2>Student Management</h2>
                    <div class="action-bar">
                        <button id="addStudentBtn" class="primary-btn">
                            <i class="fas fa-plus"></i>
                            Add Student
                        </button>
                        <div class="search-box">
                            <input type="text" id="studentSearch" placeholder="Search students...">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                    <div class="students-grid" id="studentsGrid">
                        <!-- Student cards will be populated here -->
                    </div>
                </section>

                <!-- Marks Section -->
                <section id="marks" class="admin-section">
                    <h2>Marks Management</h2>
                    <div class="action-bar">
                        <button id="addMarksBtn" class="primary-btn">
                            <i class="fas fa-plus"></i>
                            Add Marks
                        </button>
                        <button id="bulkUploadBtn" class="secondary-btn">
                            <i class="fas fa-file-upload"></i>
                            Bulk Upload
                        </button>
                        <button id="exportBtn" class="secondary-btn">
                            <i class="fas fa-file-export"></i>
                            Export Data
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Name</th>
                                    <th>Subject</th>
                                    <th>Marks</th>
                                    <th>Grade</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="marksTableBody">
                                <!-- Marks will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Reports Section -->
                <section id="reports" class="admin-section">
                    <h2>Reports</h2>
                    <div class="reports-grid">
                        <div class="report-card">
                            <h3>Performance Report</h3>
                            <canvas id="performanceReportChart"></canvas>
                        </div>
                        <div class="report-card">
                            <h3>Subject-wise Analysis</h3>
                            <canvas id="subjectReportChart"></canvas>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h2>Add New Student</h2>
            <form id="addStudentForm">
                <div class="profile-picture-section">
                    <div class="profile-picture-preview">
                        <img id="newProfilePreview" src="https://via.placeholder.com/150" alt="Profile Picture">
                    </div>
                    <div class="profile-picture-upload">
                        <label for="newProfilePicture" class="upload-btn">
                            <i class="fas fa-camera"></i>
                            Upload Picture
                        </label>
                        <input type="file" id="newProfilePicture" accept="image/*" hidden>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newRollNo">Roll Number</label>
                    <input type="text" id="newRollNo" required>
                </div>
                <div class="form-group">
                    <label for="newName">Name</label>
                    <input type="text" id="newName" required>
                </div>
                <div class="form-group">
                    <label for="newClass">Class</label>
                    <input type="text" id="newClass" required>
                </div>
                <div class="form-group">
                    <label for="newEmail">Email</label>
                    <input type="email" id="newEmail" required>
                </div>
                <div class="form-group">
                    <label for="newPhone">Phone</label>
                    <input type="tel" id="newPhone" required>
                </div>
                <div class="form-group">
                    <label for="newAddress">Address</label>
                    <textarea id="newAddress" required></textarea>
                </div>
                <div class="form-group">
                    <label for="newPassword">Password</label>
                    <input type="password" id="newPassword" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" onclick="closeModal('addStudentModal')">Cancel</button>
                    <button type="submit" class="primary-btn">Add Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Marks Modal -->
    <div id="addMarksModal" class="modal">
        <div class="modal-content">
            <h2>Add Marks</h2>
            <form id="addMarksForm">
                <div class="form-group">
                    <label for="marksRollNo">Roll Number</label>
                    <input type="text" id="marksRollNo" required>
                </div>
                <div class="form-group">
                    <label for="marksSubject">Subject</label>
                    <input type="text" id="marksSubject" required>
                </div>
                <div class="form-group">
                    <label for="marksObtained">Marks Obtained</label>
                    <input type="number" id="marksObtained" required>
                </div>
                <div class="form-group">
                    <label for="marksTotal">Total Marks</label>
                    <input type="number" id="marksTotal" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" onclick="closeModal('addMarksModal')">Cancel</button>
                    <button type="submit" class="primary-btn">Add Marks</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="modal">
        <div class="modal-content">
            <h2>Bulk Upload Marks</h2>
            <form id="bulkUploadForm">
                <div class="form-group">
                    <label for="marksFile">Upload JSON File</label>
                    <input type="file" id="marksFile" accept=".json" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" onclick="closeModal('bulkUploadModal')">Cancel</button>
                    <button type="submit" class="primary-btn">Upload</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Student Profile Modal -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <h2>Edit Student Profile</h2>
            <form id="editStudentForm">
                <div class="profile-picture-section">
                    <div class="profile-picture-preview">
                        <img id="profilePreview" src="" alt="Profile Picture">
                    </div>
                    <div class="profile-picture-upload">
                        <label for="profilePicture" class="upload-btn">
                            <i class="fas fa-camera"></i>
                            Change Picture
                        </label>
                        <input type="file" id="profilePicture" accept="image/*" hidden>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editRollNo">Roll Number</label>
                    <input type="text" id="editRollNo" required>
                </div>
                <div class="form-group">
                    <label for="editName">Name</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label for="editClass">Class</label>
                    <input type="text" id="editClass" required>
                </div>
                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" required>
                </div>
                <div class="form-group">
                    <label for="editPhone">Phone</label>
                    <input type="tel" id="editPhone" required>
                </div>
                <div class="form-group">
                    <label for="editAddress">Address</label>
                    <textarea id="editAddress" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" onclick="closeModal('editStudentModal')">Cancel</button>
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Marks Modal -->
    <div id="editMarksModal" class="modal">
        <div class="modal-content">
            <h2>Edit Marks</h2>
            <form id="editMarksForm">
                <div class="form-group">
                    <label for="editMarksRollNo">Roll Number</label>
                    <input type="text" id="editMarksRollNo" required readonly>
                </div>
                <div class="form-group">
                    <label for="editMarksSubject">Subject</label>
                    <input type="text" id="editMarksSubject" required readonly>
                </div>
                <div class="form-group">
                    <label for="editMarksObtained">Marks Obtained</label>
                    <input type="number" id="editMarksObtained" required>
                </div>
                <div class="form-group">
                    <label for="editMarksTotal">Total Marks</label>
                    <input type="number" id="editMarksTotal" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="secondary-btn" onclick="closeModal('editMarksModal')">Cancel</button>
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is logged in as admin
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || currentUser.type !== 'admin') {
                window.location.replace('index.html');
                return;
            }

            // Theme toggle functionality
            const themeToggle = document.getElementById('themeToggle');
            const currentTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';

            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            });

            // Navigation functionality
            const navItems = document.querySelectorAll('.admin-sidebar li');
            const sections = document.querySelectorAll('.admin-section');

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    navItems.forEach(nav => nav.classList.remove('active'));
                    sections.forEach(section => section.classList.remove('active'));
                    
                    item.classList.add('active');
                    document.getElementById(item.dataset.section).classList.add('active');
                });
            });

            // Update dashboard statistics
            updateDashboardStats();

            // Load students grid
            loadStudentsGrid();

            // Load marks table
            loadMarksTable();

            // Modal functionality
            document.getElementById('addStudentBtn').addEventListener('click', () => {
                openModal('addStudentModal');
            });

            document.getElementById('addMarksBtn').addEventListener('click', () => {
                openModal('addMarksModal');
            });

            document.getElementById('bulkUploadBtn').addEventListener('click', () => {
                openModal('bulkUploadModal');
            });

            // Export functionality
            document.getElementById('exportBtn').addEventListener('click', () => {
                dataManager.exportToJSON();
            });

            // Bulk upload functionality
            document.getElementById('bulkUploadForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = document.getElementById('marksFile').files[0];
                try {
                    await dataManager.handleFileUpload(file);
                    closeModal('bulkUploadModal');
                    loadMarksTable();
                    updateDashboardStats();
                } catch (error) {
                    alert('Error uploading file: ' + error.message);
                }
            });

            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.replace('index.html');
            });

            // New student profile picture preview
            document.getElementById('newProfilePicture').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('newProfilePreview').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Add student form submission
            document.getElementById('addStudentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const profilePicture = document.getElementById('newProfilePicture').files[0];
                
                const studentData = {
                    rollNo: document.getElementById('newRollNo').value,
                    name: document.getElementById('newName').value,
                    class: document.getElementById('newClass').value,
                    email: document.getElementById('newEmail').value,
                    phone: document.getElementById('newPhone').value,
                    address: document.getElementById('newAddress').value,
                    password: document.getElementById('newPassword').value,
                    marks: []
                };

                if (profilePicture) {
                    studentData.profilePicture = profilePicture;
                }

                if (dataManager.addStudent(studentData)) {
                    closeModal('addStudentModal');
                    loadStudentsGrid();
                    updateDashboardStats();
                }
            });

            // Add marks form submission
            document.getElementById('addMarksForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const marksData = {
                    subject: document.getElementById('marksSubject').value,
                    marks: parseInt(document.getElementById('marksObtained').value),
                    total: parseInt(document.getElementById('marksTotal').value)
                };

                // Calculate grade
                const percentage = dataManager.calculatePercentage(marksData.marks, marksData.total);
                marksData.grade = dataManager.calculateGrade(percentage);

                const rollNo = document.getElementById('marksRollNo').value;
                if (dataManager.addMarks(rollNo, marksData)) {
                    closeModal('addMarksModal');
                    loadMarksTable();
                    updateDashboardStats();
                }
            });

            // Profile picture preview for edit form
            document.getElementById('profilePicture').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('profilePreview').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Edit student form submission
            document.getElementById('editStudentForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const rollNo = document.getElementById('editRollNo').value;
                const profilePicture = document.getElementById('profilePicture').files[0];
                
                const updatedData = {
                    name: document.getElementById('editName').value,
                    class: document.getElementById('editClass').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    address: document.getElementById('editAddress').value
                };

                if (profilePicture) {
                    updatedData.profilePicture = profilePicture;
                }

                try {
                    const success = await dataManager.updateStudentProfile(rollNo, updatedData);
                    if (success) {
                        closeModal('editStudentModal');
                        loadStudentsGrid();
                        updateDashboardStats();
                    }
                } catch (error) {
                    alert('Error updating student profile: ' + error.message);
                }
            });

            function editMarks(rollNo, subject) {
                const student = dataManager.getStudent(rollNo);
                if (student) {
                    const mark = student.marks.find(m => m.subject === subject);
                    if (mark) {
                        document.getElementById('editMarksRollNo').value = rollNo;
                        document.getElementById('editMarksSubject').value = subject;
                        document.getElementById('editMarksObtained').value = mark.marks;
                        document.getElementById('editMarksTotal').value = mark.total;
                        
                        openModal('editMarksModal');
                    }
                }
            }

            // Edit marks form submission
            document.getElementById('editMarksForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const rollNo = document.getElementById('editMarksRollNo').value;
                const subject = document.getElementById('editMarksSubject').value;
                const marksData = {
                    subject: subject,
                    marks: parseInt(document.getElementById('editMarksObtained').value),
                    total: parseInt(document.getElementById('editMarksTotal').value)
                };

                // Calculate grade
                const percentage = dataManager.calculatePercentage(marksData.marks, marksData.total);
                marksData.grade = dataManager.calculateGrade(percentage);

                if (dataManager.updateMarks(rollNo, subject, marksData)) {
                    closeModal('editMarksModal');
                    loadMarksTable();
                    updateDashboardStats();
                }
            });
        });

        function updateDashboardStats() {
            const students = dataManager.getAllStudents();
            const totalStudents = students.length;
            let totalScore = 0;
            let topPerformers = 0;
            let needAttention = 0;

            students.forEach(student => {
                if (student.marks.length > 0) {
                    const avgScore = student.marks.reduce((acc, mark) => acc + (mark.marks / mark.total), 0) / student.marks.length * 100;
                    totalScore += avgScore;

                    if (avgScore >= 90) topPerformers++;
                    if (avgScore < 50) needAttention++;
                }
            });

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('avgScore').textContent = totalStudents > 0 ? Math.round(totalScore / totalStudents) + '%' : '0%';
            document.getElementById('topPerformers').textContent = topPerformers;
            document.getElementById('needAttention').textContent = needAttention;
        }

        function loadStudentsGrid() {
            const grid = document.getElementById('studentsGrid');
            grid.innerHTML = '';
            
            dataManager.getAllStudents().forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div class="student-card-header">
                        <div class="student-profile-picture">
                            <img src="${student.profilePicture}" alt="${student.name}">
                        </div>
                        <div class="student-info">
                            <h3>${student.name}</h3>
                            <p>Roll No: ${student.rollNo}</p>
                            <p>Class: ${student.class}</p>
                        </div>
                    </div>
                    <div class="student-card-body">
                        <p><i class="fas fa-envelope"></i> ${student.email}</p>
                        <p><i class="fas fa-phone"></i> ${student.phone}</p>
                    </div>
                    <div class="student-card-actions">
                        <button class="action-btn edit" onclick="editStudent('${student.rollNo}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                        <button class="action-btn delete" onclick="deleteStudent('${student.rollNo}')">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function loadMarksTable() {
            const tbody = document.getElementById('marksTableBody');
            tbody.innerHTML = '';
            
            dataManager.getAllStudents().forEach(student => {
                student.marks.forEach(mark => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.rollNo}</td>
                        <td>${student.name}</td>
                        <td>${mark.subject}</td>
                        <td>${mark.marks}/${mark.total}</td>
                        <td>${mark.grade}</td>
                        <td>
                            <button class="action-btn edit" onclick="editMarks('${student.rollNo}', '${mark.subject}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteMarks('${student.rollNo}', '${mark.subject}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function editStudent(rollNo) {
            const student = dataManager.getStudent(rollNo);
            if (student) {
                document.getElementById('profilePreview').src = student.profilePicture;
                document.getElementById('editRollNo').value = student.rollNo;
                document.getElementById('editName').value = student.name;
                document.getElementById('editClass').value = student.class;
                document.getElementById('editEmail').value = student.email;
                document.getElementById('editPhone').value = student.phone;
                document.getElementById('editAddress').value = student.address;
                
                openModal('editStudentModal');
            }
        }

        function deleteStudent(rollNo) {
            if (confirm('Are you sure you want to delete this student?')) {
                if (dataManager.deleteStudent(rollNo)) {
                    loadStudentsGrid();
                    updateDashboardStats();
                }
            }
        }

        function deleteMarks(rollNo, subject) {
            if (confirm('Are you sure you want to delete these marks?')) {
                if (dataManager.deleteMarks(rollNo, subject)) {
                    loadMarksTable();
                    updateDashboardStats();
                }
            }
        }
    </script>
</body>
</html> 